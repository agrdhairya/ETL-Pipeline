<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple ETL Pipeline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple spinner */
        .loader {
            border-top-color: #3b82f6; /* blue-500 */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notification animation */
        .toast-enter {
            opacity: 0;
            transform: translateY(100%);
        }
        .toast-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: all 300ms ease-out;
        }
        .toast-exit-active {
            opacity: 0;
            transform: translateY(100%);
            transition: all 300ms ease-in;
        }
        
        /* Show copy icon on table cell hover */
        .table-cell-copy-icon {
            opacity: 0;
            transition: opacity 150ms ease-in-out;
            cursor: pointer;
        }
        td:hover .table-cell-copy-icon {
            opacity: 0.5;
        }
        td .table-cell-copy-icon:hover {
            opacity: 1;
        }
        
        /* Sticky table header */
        thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <div class="container mx-auto max-w-6xl p-4 md:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-900">Dynamic ETL Pipeline</h1>
            <p class="text-lg text-gray-600 mt-2">Upload a file or paste text below to extract, transform, and load it instantly.</p>
        </header>

        <!-- Input Section -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <label class="block text-sm font-medium text-gray-700 mb-2">Upload File</label>
            
            <!-- New Drop Zone -->
            <div id="drop-zone" class="relative border-2 border-dashed border-gray-300 rounded-lg p-10 text-center cursor-pointer hover:border-blue-500 transition-colors duration-200 bg-gray-50">
                <div class="flex flex-col items-center justify-center">
                    <svg class="w-12 h-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
                    </svg>
                    <p class="mt-2 text-sm text-gray-600">
                        <span class="font-semibold text-blue-600">Click to upload</span> or drag and drop
                    </p>
                    <p class="text-xs text-gray-500">A single text file (.txt, .html, .json, etc.)</p>
                </div>
                <input id="file-input" type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
            </div>
            
            <div class="my-4 flex items-center">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-500">OR</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>
            
            <label for="input-data" class="block text-sm font-medium text-gray-700 mb-2">Paste Text Manually</label>
            <textarea id="input-data" rows="10"
                class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 font-mono text-sm"
                placeholder="Paste your mixed <HTML>, <JSON>, <TEXT>, and <BASE64> blocks here..."></textarea>
            
            <div class="mt-4 flex flex-wrap gap-4">
                <button id="process-btn"
                    class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-150 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-3 -ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                    Process Data
                </button>
                <button id="clear-btn"
                    class="inline-flex items-center px-6 py-3 border border-gray-300 text-base font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-150 transform hover:scale-105">
                    <svg class="w-5 h-5 mr-3 -ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                    </svg>
                    Clear
                </button>
            </div>
        </div>

        <!-- Status & Error Messages -->
        <div id="loading-spinner" class="hidden my-4 flex items-center justify-center p-8">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
            <span class="ml-4 text-gray-600 text-lg">Processing data...</span>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                    <h2 class="text-2xl font-semibold mb-3 sm:mb-0">Extracted Data</h2>
                    <button id="download-csv-btn"
                        class="inline-flex items-center px-4 py-2 border border-green-600 text-sm font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-150 transform hover:scale-105">
                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        Download as CSV
                    </button>
                </div>
            </div>
            <div id="results-table-container" class="overflow-x-auto max-h-[600px]">
                <!-- Table will be injected here by JavaScript -->
            </div>
        </div>

    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-0 right-0 m-8 p-4 rounded-lg shadow-lg bg-gray-800 text-white max-w-sm hidden toast-enter">
        <div class="flex items-center">
            <svg id="toast-icon-success" class="w-6 h-6 text-green-500 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <svg id="toast-icon-error" class="w-6 h-6 text-red-500 mr-3 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0-10.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.75c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.57-.598-3.75h-.152c-3.196 0-6.1-1.249-8.25-3.286zm0 13.036h.008v.008H12v-.008z" />
            </svg>
            <svg id="toast-icon-warn" class="w-6 h-6 text-yellow-500 mr-3 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.03-1.5-3.896 0L2.697 16.126z" />
            </svg>
            <span id="toast-message">Success!</span>
        </div>
    </div>


    <script>
        let processedJsonData = []; // Store data for CSV download
        let toastTimer;

        // --- DOM Elements ---
        const processBtn = document.getElementById('process-btn');
        const clearBtn = document.getElementById('clear-btn');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        const inputData = document.getElementById('input-data');
        
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultsSection = document.getElementById('results-section');
        const tableContainer = document.getElementById('results-table-container');

        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const toastIconSuccess = document.getElementById('toast-icon-success');
        const toastIconError = document.getElementById('toast-icon-error');
        const toastIconWarn = document.getElementById('toast-icon-warn');
        
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');


        /**
         * Main function to send data to the backend for processing.
         */
        async function processData() {
            const rawContent = inputData.value;
            if (!rawContent.trim()) {
                showToast('Input data cannot be empty.', 'warn');
                return;
            }

            // --- UI Setup ---
            clearResults();
            resultsSection.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            processBtn.disabled = true;
            processBtn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                // --- API Call ---
                // FIX: Use the full URL for the Flask server
                const response = await fetch('http://127.0.0.1:5000/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain' // Send as raw text
                    },
                    body: rawContent
                });

                if (!response.ok) {
                    const errText = await response.text(); // Try to get text for more info
                    console.error("Server response text:", errText);
                    let err = {};
                    try {
                        err = JSON.parse(errText); // See if it's JSON
                    } catch (e) {
                        err = { error: errText || `Server error: ${response.statusText}` }
                    }
                    throw new Error(err.error);
                }

                const jsonData = await response.json();
                
                // Handle the response structure
                let data = [];
                if (jsonData.data && Array.isArray(jsonData.data)) {
                    data = jsonData.data;
                } else if (Array.isArray(jsonData)) {
                    data = jsonData;
                } else {
                    throw new Error('Unexpected response format');
                }
                
                // --- Success ---
                processedJsonData = data; // Save for CSV download
                displayTable(data);
                resultsSection.classList.remove('hidden');
                showToast('Data processed successfully!', 'success');

            } catch (err) {
                console.error('Processing error:', err);
                // Handle common fetch error (network, CORS, server down)
                if (err.message.includes('Failed to fetch')) {
                    showToast('Error: Could not connect to backend. Is the Python server running?', 'error');
                } else {
                    showToast(err.message, 'error');
                }
                processedJsonData = []; // Clear data on error
            } finally {
                // --- UI Teardown ---
                loadingSpinner.classList.add('hidden');
                processBtn.disabled = false;
                processBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        /**
         * Renders the processed data into an HTML table.
         */
        function displayTable(data) {
            if (!data || data.length === 0) {
                tableContainer.innerHTML = '<p class="text-gray-500 p-8 text-center">No data was extracted or processed.</p>';
                return;
            }

            const headers = Object.keys(data[0]);

            // Create table structure
            let tableHtml = '<table class="min-w-full divide-y divide-gray-200">';
            
            // Table Header
            tableHtml += '<thead class="bg-gray-100">'; // Changed for better stickiness
            tableHtml += '<tr>';
            headers.forEach(header => {
                tableHtml += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header.replace(/_/g, ' ')}</th>`;
            });
            tableHtml += '</tr></thead>';

            // Table Body
            tableHtml += '<tbody class="bg-white divide-y divide-gray-200">';
            data.forEach((row, index) => {
                tableHtml += `<tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50">`; // Zebra striping
                headers.forEach(header => {
                    const value = row[header] === null || row[header] === undefined ? '' : row[header];
                    // Truncate long text for display
                    let displayValue = String(value);
                    if (displayValue.length > 75) {
                        displayValue = displayValue.substring(0, 75) + '...';
                    }
                    
                    const fullValueEscaped = escapeHtml(String(value));
                    
                    tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 relative group" title="Click to copy">
                                    <div class="flex justify-between items-center">
                                        <span>${escapeHtml(displayValue)}</span>
                                        ${value ? // Only show copy icon if there is content
                                        `<svg onclick="copyToClipboard('${fullValueEscaped}')" class="w-4 h-4 text-gray-400 table-cell-copy-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.353-.026.71.056.99.23.29.174.55.45.743.794.194.344.29.75.29 1.158v1.392M16.5 7.5v1.392c0 .408-.095.814-.29 1.158-.193.344-.453.62-.743.794-.28.174-.637.256-.99.23-1.131-.094-1.976-1.057-1.976-2.192V6.108c0-1.135.845-2.098 1.976-2.192.353-.026.71.056.99.23.29.174.55.45.743.794.194.344.29.75.29 1.158v1.392h-6.116" />
                                        </svg>` : ''}
                                    </div>
                                </td>`;
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table>';

            tableContainer.innerHTML = tableHtml;
        }

        /**
         * Triggers a browser download of the processed data as a CSV file.
         */
        function downloadCSV() {
            if (processedJsonData.length === 0) {
                showToast('No data to download.', 'warn');
                return;
            }

            const headers = Object.keys(processedJsonData[0]);
            const csvRows = [headers.join(',')]; // Header row

            // Data rows
            processedJsonData.forEach(row => {
                const values = headers.map(header => {
                    let cell = row[header] === null || row[header] === undefined ? '' : String(row[header]);
                    // Escape quotes and wrap in quotes if it contains comma or newline
                    cell = cell.replace(/"/g, '""');
                    if (cell.includes(',') || cell.includes('\n')) {
                        cell = `"${cell}"`;
                    }
                    return cell;
                });
                csvRows.push(values.join(','));
            });

            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'cleaned_output.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('CSV download started.', 'success');
        }

        /**
         * Clears the input and results.
         */
        function clearAll() {
            inputData.value = '';
            fileInput.value = ''; // Reset file input
            clearResults();
            showToast('Cleared input and results.', 'success');
        }

        function clearResults() {
            processedJsonData = [];
            resultsSection.classList.add('hidden');
            tableContainer.innerHTML = '';
        }
        
        // --- File Handling Functions ---

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        function processFile(file) {
            if (!file) {
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const text = e.target.result;
                inputData.value = text; // Put content in textarea
                showToast(`File '${file.name}' loaded. Processing...`, 'success');
                processData(); // Automatically process the data
            };
            
            reader.onerror = (e) => {
                console.error('File reading error:', e);
                showToast(`Failed to read file: ${file.name}`, 'error');
            };
            
            reader.readAsText(file);
        }

        // --- Utility Functions ---

        /**
         * Shows a toast notification.
         * @param {string} message - The message to display.
         * @param {'success' | 'error' | 'warn'} type - The type of toast.
         */
        function showToast(message, type = 'success') {
            // Clear any existing timer
            if (toastTimer) clearTimeout(toastTimer);

            toastMessage.textContent = message;
            
            // Hide all icons
            toastIconSuccess.classList.add('hidden');
            toastIconError.classList.add('hidden');
            toastIconWarn.classList.add('hidden');

            // Show the correct icon and set color
            if (type === 'success') {
                toastIconSuccess.classList.remove('hidden');
                toast.style.backgroundColor = '#22c55e'; // green-500
            } else if (type === 'error') {
                toastIconError.classList.remove('hidden');
                toast.style.backgroundColor = '#ef4444'; // red-500
            } else if (type === 'warn') {
                toastIconWarn.classList.remove('hidden');
                toast.style.backgroundColor = '#f59e0b'; // amber-500
            }

            // Animate in
            toast.classList.remove('hidden');
            toast.classList.remove('toast-exit-active');
            toast.classList.add('toast-enter-active');

            // Set timer to animate out
            toastTimer = setTimeout(() => {
                toast.classList.remove('toast-enter-active');
                toast.classList.add('toast-exit-active');
                // Optional: hide element after animation
                // setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }
        
        function unescapeHtml(safe) {
            if (safe === null || safe === undefined) return '';
            return String(safe)
                .replace(/&amp;/g, "&")
                .replace(/&lt;/g, "<")
                .replace(/&gt;/g, ">")
                .replace(/&quot;/g, "\"")
                .replace(/&#039;/g, "'");
        }

        function copyToClipboard(text) {
            // We must unescape the text before copying
            const unescapedText = unescapeHtml(text);
            
            // Use an invisible textarea to copy
            const textarea = document.createElement('textarea');
            textarea.value = unescapedText;
            textarea.style.position = 'fixed'; // prevent screen flash
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                // Use execCommand as a fallback for iframe environments
                document.execCommand('copy');
                showToast('Copied to clipboard!', 'success');
            } catch (err) {
                console.error('Copy to clipboard failed:', err);
                showToast('Failed to copy.', 'error');
            }
            
            document.body.removeChild(textarea);
        }

        // --- Event Listeners ---
        processBtn.addEventListener('click', processData);
        clearBtn.addEventListener('click', clearAll);
        downloadCsvBtn.addEventListener('click', downloadCSV);
        
        // Drag and drop listeners
        dropZone.addEventListener('dragover', handleDragOver);
        dropZone.addEventListener('dragleave', handleDragLeave);
        dropZone.addEventListener('drop', handleDrop);
        
        // File input listener
        fileInput.addEventListener('change', handleFileSelect);

    </script>
</body>
</html>